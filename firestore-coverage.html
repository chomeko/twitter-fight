<!DOCTYPE html>
<meta charset="utf-8">
<title>Firestore Rule Coverage Report</title>
<style>
.coverage-expr {
  padding-bottom: 4px;
  display: inline-block;
  border-bottom: 3px solid black;
  vertical-align: top;
}
.coverage-expr:hover {
  background-color: rgba(255, 100, 100, 0.2);
  cursor: default;
  border-bottom: 3px solid red;
}
</style>

<script>
// Populated by the emulator at runtime
const data = {
  "rules": {
    "files": [{
      "content": "rules_version \u003d \u00272\u0027;\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /sutefuri/{uid} {\n      allow read: if request.auth !\u003d null;\n      allow write: if request.auth.uid \u003d\u003d uid;\n        match /equip/{document\u003d**} {\n          allow read: if request.auth.uid \u003d\u003d uid;\n          allow write: if request.auth.uid \u003d\u003d uid;\n        }\n    }\n    match /users/{uid} {\n      allow read: if request.auth !\u003d null;\n      allow write: if request.auth.uid \u003d\u003d uid;\n        match /titles/{document\u003d**} {\n          allow read: if request.auth.uid \u003d\u003d uid;\n          allow write: if request.auth.uid \u003d\u003d uid;\n        }\n    }\n    match /titles/{document\u003d**} {\n      allow read: if request.auth !\u003d null;\n      allow write: if false;\n    }\n  }\n}"
    }]
  },
  "report": [{
    "sourcePosition": {
      "line": 8,
      "column": 26,
      "currentOffset": 269,
      "endOffset": 291
    },
    "children": [{
      "sourcePosition": {
        "line": 8,
        "column": 26,
        "currentOffset": 269,
        "endOffset": 284
      },
      "children": [{
        "sourcePosition": {
          "line": 8,
          "column": 26,
          "currentOffset": 269,
          "endOffset": 280
        },
        "children": [{
          "sourcePosition": {
            "line": 8,
            "column": 26,
            "currentOffset": 269,
            "endOffset": 275
          }
        }]
      }]
    }, {
      "sourcePosition": {
        "line": 8,
        "column": 46,
        "currentOffset": 289,
        "endOffset": 291
      }
    }]
  }, {
    "sourcePosition": {
      "line": 9,
      "column": 27,
      "currentOffset": 320,
      "endOffset": 342
    },
    "children": [{
      "sourcePosition": {
        "line": 9,
        "column": 27,
        "currentOffset": 320,
        "endOffset": 335
      },
      "children": [{
        "sourcePosition": {
          "line": 9,
          "column": 27,
          "currentOffset": 320,
          "endOffset": 331
        },
        "children": [{
          "sourcePosition": {
            "line": 9,
            "column": 27,
            "currentOffset": 320,
            "endOffset": 326
          }
        }]
      }]
    }, {
      "sourcePosition": {
        "line": 9,
        "column": 47,
        "currentOffset": 340,
        "endOffset": 342
      }
    }]
  }, {
    "sourcePosition": {
      "line": 5,
      "column": 22,
      "currentOffset": 138,
      "endOffset": 157
    },
    "children": [{
      "sourcePosition": {
        "line": 5,
        "column": 22,
        "currentOffset": 138,
        "endOffset": 149
      },
      "children": [{
        "sourcePosition": {
          "line": 5,
          "column": 22,
          "currentOffset": 138,
          "endOffset": 144
        }
      }]
    }]
  }, {
    "sourcePosition": {
      "line": 6,
      "column": 23,
      "currentOffset": 182,
      "endOffset": 204
    },
    "values": [{
      "value": {
        "boolValue": true
      },
      "count": 7
    }, {
      "value": {
        "boolValue": false
      },
      "count": 3
    }],
    "children": [{
      "sourcePosition": {
        "line": 6,
        "column": 23,
        "currentOffset": 182,
        "endOffset": 197
      },
      "values": [{
        "value": {
          "stringValue": "alice"
        },
        "count": 7
      }, {
        "value": {
          "stringValue": "bob"
        },
        "count": 3
      }],
      "children": [{
        "sourcePosition": {
          "line": 6,
          "column": 23,
          "currentOffset": 182,
          "endOffset": 193
        },
        "values": [{
          "value": {
            "mapValue": {
              "fields": {
                "uid": {
                  "stringValue": "alice"
                },
                "token": {
                  "mapValue": {
                    "fields": {
                      "uid": {
                        "stringValue": "alice"
                      },
                      "iat": {
                        "intValue": "0"
                      },
                      "sub": {
                        "stringValue": "alice"
                      }
                    }
                  }
                }
              }
            }
          },
          "count": 7
        }, {
          "value": {
            "mapValue": {
              "fields": {
                "uid": {
                  "stringValue": "bob"
                },
                "token": {
                  "mapValue": {
                    "fields": {
                      "uid": {
                        "stringValue": "bob"
                      },
                      "iat": {
                        "intValue": "0"
                      },
                      "sub": {
                        "stringValue": "bob"
                      }
                    }
                  }
                }
              }
            }
          },
          "count": 3
        }],
        "children": [{
          "sourcePosition": {
            "line": 6,
            "column": 23,
            "currentOffset": 182,
            "endOffset": 188
          },
          "values": [{
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.237Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.237Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.615Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "bob"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "bob"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "bob"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.615Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.684Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.684Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.694Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "updateAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "updateAt"
                      }, {
                        "stringValue": "owner"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.684Z"
                              },
                              "updateAt": {
                                "timestampValue": "2020-10-02T15:01:56.694Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "update"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.740Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.740Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.781Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "bob"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "bob"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "bob"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }, {
                        "stringValue": "owner"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.781Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "update"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.827Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.827Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.835Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "nullValue": null
                  },
                  "writeFields": {
                    "nullValue": null
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "nullValue": null
                  },
                  "method": {
                    "stringValue": "delete"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.878Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:56.878Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "sutefuri"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:56.911Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "bob"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "bob"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "bob"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "sutefuri"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "nullValue": null
                  },
                  "writeFields": {
                    "nullValue": null
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "nullValue": null
                  },
                  "method": {
                    "stringValue": "delete"
                  }
                }
              }
            },
            "count": 1
          }]
        }]
      }]
    }, {
      "sourcePosition": {
        "line": 6,
        "column": 43,
        "currentOffset": 202,
        "endOffset": 204
      },
      "values": [{
        "value": {
          "stringValue": "alice"
        },
        "count": 10
      }]
    }]
  }, {
    "sourcePosition": {
      "line": 16,
      "column": 26,
      "currentOffset": 539,
      "endOffset": 561
    },
    "children": [{
      "sourcePosition": {
        "line": 16,
        "column": 26,
        "currentOffset": 539,
        "endOffset": 554
      },
      "children": [{
        "sourcePosition": {
          "line": 16,
          "column": 26,
          "currentOffset": 539,
          "endOffset": 550
        },
        "children": [{
          "sourcePosition": {
            "line": 16,
            "column": 26,
            "currentOffset": 539,
            "endOffset": 545
          }
        }]
      }]
    }, {
      "sourcePosition": {
        "line": 16,
        "column": 46,
        "currentOffset": 559,
        "endOffset": 561
      }
    }]
  }, {
    "sourcePosition": {
      "line": 17,
      "column": 27,
      "currentOffset": 590,
      "endOffset": 612
    },
    "children": [{
      "sourcePosition": {
        "line": 17,
        "column": 27,
        "currentOffset": 590,
        "endOffset": 605
      },
      "children": [{
        "sourcePosition": {
          "line": 17,
          "column": 27,
          "currentOffset": 590,
          "endOffset": 601
        },
        "children": [{
          "sourcePosition": {
            "line": 17,
            "column": 27,
            "currentOffset": 590,
            "endOffset": 596
          }
        }]
      }]
    }, {
      "sourcePosition": {
        "line": 17,
        "column": 47,
        "currentOffset": 610,
        "endOffset": 612
      }
    }]
  }, {
    "sourcePosition": {
      "line": 13,
      "column": 22,
      "currentOffset": 407,
      "endOffset": 426
    },
    "children": [{
      "sourcePosition": {
        "line": 13,
        "column": 22,
        "currentOffset": 407,
        "endOffset": 418
      },
      "children": [{
        "sourcePosition": {
          "line": 13,
          "column": 22,
          "currentOffset": 407,
          "endOffset": 413
        }
      }]
    }]
  }, {
    "sourcePosition": {
      "line": 14,
      "column": 23,
      "currentOffset": 451,
      "endOffset": 473
    },
    "values": [{
      "value": {
        "boolValue": true
      },
      "count": 7
    }, {
      "value": {
        "boolValue": false
      },
      "count": 3
    }],
    "children": [{
      "sourcePosition": {
        "line": 14,
        "column": 23,
        "currentOffset": 451,
        "endOffset": 466
      },
      "values": [{
        "value": {
          "stringValue": "alice"
        },
        "count": 7
      }, {
        "value": {
          "stringValue": "bob"
        },
        "count": 3
      }],
      "children": [{
        "sourcePosition": {
          "line": 14,
          "column": 23,
          "currentOffset": 451,
          "endOffset": 462
        },
        "values": [{
          "value": {
            "mapValue": {
              "fields": {
                "uid": {
                  "stringValue": "alice"
                },
                "token": {
                  "mapValue": {
                    "fields": {
                      "uid": {
                        "stringValue": "alice"
                      },
                      "iat": {
                        "intValue": "0"
                      },
                      "sub": {
                        "stringValue": "alice"
                      }
                    }
                  }
                }
              }
            }
          },
          "count": 7
        }, {
          "value": {
            "mapValue": {
              "fields": {
                "uid": {
                  "stringValue": "bob"
                },
                "token": {
                  "mapValue": {
                    "fields": {
                      "uid": {
                        "stringValue": "bob"
                      },
                      "iat": {
                        "intValue": "0"
                      },
                      "sub": {
                        "stringValue": "bob"
                      }
                    }
                  }
                }
              }
            }
          },
          "count": 3
        }],
        "children": [{
          "sourcePosition": {
            "line": 14,
            "column": 23,
            "currentOffset": 451,
            "endOffset": 457
          },
          "values": [{
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.006Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "nullValue": null
                  },
                  "writeFields": {
                    "nullValue": null
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "photoURL": {
                                "stringValue": "URL"
                              },
                              "name": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.043Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "bob"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "bob"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "bob"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.043Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.084Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.084Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.090Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "updateAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "updateAt"
                      }, {
                        "stringValue": "owner"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.084Z"
                              },
                              "updateAt": {
                                "timestampValue": "2020-10-02T15:01:57.090Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "update"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.127Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.127Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.156Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "bob"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "bob"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "bob"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }, {
                        "stringValue": "owner"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.156Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "update"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.195Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.195Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.201Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "nullValue": null
                  },
                  "writeFields": {
                    "nullValue": null
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "nullValue": null
                  },
                  "method": {
                    "stringValue": "delete"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.232Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "alice"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "alice"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "alice"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "writeFields": {
                    "listValue": {
                      "values": [{
                        "stringValue": "createAt"
                      }]
                    }
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "mapValue": {
                      "fields": {
                        "data": {
                          "mapValue": {
                            "fields": {
                              "owner": {
                                "stringValue": "alice"
                              },
                              "createAt": {
                                "timestampValue": "2020-10-02T15:01:57.232Z"
                              }
                            }
                          }
                        },
                        "__name__": {
                          "pathValue": {
                            "segments": [{
                              "simple": "databases"
                            }, {
                              "simple": "(default)"
                            }, {
                              "simple": "documents"
                            }, {
                              "simple": "users"
                            }, {
                              "simple": "alice"
                            }]
                          }
                        },
                        "id": {
                          "stringValue": "alice"
                        }
                      }
                    }
                  },
                  "method": {
                    "stringValue": "create"
                  }
                }
              }
            },
            "count": 1
          }, {
            "value": {
              "mapValue": {
                "fields": {
                  "time": {
                    "timestampValue": "2020-10-02T15:01:57.258Z"
                  },
                  "auth": {
                    "mapValue": {
                      "fields": {
                        "uid": {
                          "stringValue": "bob"
                        },
                        "token": {
                          "mapValue": {
                            "fields": {
                              "uid": {
                                "stringValue": "bob"
                              },
                              "iat": {
                                "intValue": "0"
                              },
                              "sub": {
                                "stringValue": "bob"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "headers": {
                    "mapValue": {
                    }
                  },
                  "inTransaction": {
                    "boolValue": true
                  },
                  "path": {
                    "pathValue": {
                      "segments": [{
                        "simple": "databases"
                      }, {
                        "simple": "(default)"
                      }, {
                        "simple": "documents"
                      }, {
                        "simple": "users"
                      }, {
                        "simple": "alice"
                      }]
                    }
                  },
                  "transforms": {
                    "nullValue": null
                  },
                  "writeFields": {
                    "nullValue": null
                  },
                  "readFields": {
                    "nullValue": null
                  },
                  "resource": {
                    "nullValue": null
                  },
                  "method": {
                    "stringValue": "delete"
                  }
                }
              }
            },
            "count": 1
          }]
        }]
      }]
    }, {
      "sourcePosition": {
        "line": 14,
        "column": 43,
        "currentOffset": 471,
        "endOffset": 473
      },
      "values": [{
        "value": {
          "stringValue": "alice"
        },
        "count": 10
      }]
    }]
  }, {
    "sourcePosition": {
      "line": 21,
      "column": 22,
      "currentOffset": 686,
      "endOffset": 705
    },
    "children": [{
      "sourcePosition": {
        "line": 21,
        "column": 22,
        "currentOffset": 686,
        "endOffset": 697
      },
      "children": [{
        "sourcePosition": {
          "line": 21,
          "column": 22,
          "currentOffset": 686,
          "endOffset": 692
        }
      }]
    }]
  }]
};

const REPORT_LIMIT_SIZE = 15

window.onload = function() {
  if (data.rules.files.length == 1) {
    document.body.appendChild(buildFormattedReport(data.report || [], data.rules.files[0].content))
  } else {
    document.body.appendChild(document.createTextNode('Only single-file rules supported. ' +
    'If you encounter this please visit https://github.com/firebase/firebase-tools/issues'))
  }
};

/**
 * Builds the html block with span elements for rule visualization.
 *
 * @param expressionList The list of expression blocks.
 * @param ruleString The full text of the rules with newlines and special characters escaped.
 * @return A <pre> html element with <span></span> around expressions and subexpressions within
 *     .write, .read, and .validate tokens so that they can be selected.
 */
function buildFormattedReport(expressionList, ruleString) {
  const elements = Object.keys(expressionList).map((key) => {
    return mapExpressionBlock(expressionList[key], ruleString)
  })
  const withText = interpolateTextNodes(
    elements,
    ruleString,
    0,
    ruleString.length
  )
  var preElement = document.createElement('pre')
  withText.forEach((element) => preElement.appendChild(element.element))
  return preElement
}

/**
 * Traverses an expression block.
 *
 * Each expression needs to be wrapped in a span and so it's children need to be immediately
 * resolved so they can be added to the element.
 *
 * @param expressionBlock The current recursive chunk of expression data.
 * @param ruleString The full text of the rules with newlines and special characters escaped.
 * @return A single object with at least the keys start, end, and element. Element is the span
 *    element for that [sub]expression. The span element should have all it's children
 *    already added.
 */
function mapExpressionBlock(expressionBlock, ruleString) {
  const start = expressionBlock.sourcePosition.currentOffset
  const end = expressionBlock.sourcePosition.endOffset + 1
  const onlyChildSpans = (expressionBlock.children || []).map(
    (child) => mapExpressionBlock(child, ruleString)
  )
  const allChildren = interpolateTextNodes(
    onlyChildSpans,
    ruleString,
    start,
    end,
    true
  )
  var span = document.createElement('span')
  allChildren.forEach((child) => {
    span.appendChild(child.element)
  })
  span.classList.add('coverage-expr')
  span.title = buildValueString(expressionBlock.values);
  return {
    element: span,
    start: start,
    end: end
  }
}

/**
 * The formatted report data has information about where subexpression are located. It does not,
 * however, have information about text around these expressions. This function takes a formatted
 * list of spans (representing expressions) and puts surrounding text into text elements and
 * returns the list of all elements in that given text-area.
 *
 * @param objs the list of spans to have their bounds interpolated. Each element in the list should
 *    formatted with the keys start, end, and element.
 * @param ruleString The full text of the rules with newlines and special characters escaped.
 * @param optStart An optional start index to start gathering text-elements from.
 * @param optEnd An optional end index to finish gathering text-elements at.
 * @param whether to remove newlines from the text values.
 * @return An interpolated list with all indices from start to end of the ruleString being
 *    included in either a span or a text element.
 */
function interpolateTextNodes(objs, ruleString, start = null, end = null, removeNewLines = false) {
  // Arrays so null objects aren't appended (options)
  const expressionStart = start !== null ? [{'end': start}] : []
  const expressionEnd = end !== null ? [{'start': end}] : []
  const sortedInnerBlocks = (objs || []).sort((a, b) => (a['start'] - b['start']))
  const blocksWithBounds = [].concat(expressionStart, sortedInnerBlocks, expressionEnd)
  const interpolatedBlocks = blocksWithBounds.reduce((allChildren, child, idx) => {
    if (allChildren && allChildren.length) {
      const lastEnd = allChildren[allChildren.length - 1]['end']
      const thisStart = child['start']
      // This is an array so that we don't append null objects
      if (lastEnd < thisStart) {
        const text = ruleString.substring(lastEnd, thisStart)
        const textElement = [{
          element: document.createTextNode(removeNewLines ? text.replace(/\n\s*/g,' ') : text),
          'start': allChildren[allChildren.length - 1]['end'],
          'end': child['start']
        }]
        return allChildren.concat(textElement, child)
      }
    }
    return allChildren.concat(child)
  }, [])
  return interpolatedBlocks.filter(
    (child) => child['start'] !== undefined && child['end'] !== undefined
  )
}

/**
 * Creates the mouse-over text for each span.
 *
 * @param values The array of value objects formatted as {value: **, count: **}.
 * @return A single string for the mouse-over text.
 */
function buildValueString(values) {
  if (!values || !values.length) {
    return 'Expression never evaluated'
  } else if (values.length >= REPORT_LIMIT_SIZE) {
    const allCounts = values.reduce((acc, obj) => acc + obj.count, 0)
    return `${values.length} distinct items returned over ${allCounts} times`
  } else {
    return values.map(({value, count}) => {
      const allowedTypes = ['nullValue', 'boolValue', 'intValue', 'floatValue', 'stringValue',
        'bytesValue', 'durationValue', 'timestampValue', 'latlngValue', 'pathValue']
      const compressedTypes = ['mapValue', 'listValue', 'constraintValue']
      const typeAllowed = allowedTypes.filter(type => value[type] !== undefined).length == 1
      const typeCompressed = compressedTypes.filter(type => value[type] !== undefined).length >= 1
      // Format is value = {returnType: returnValue}
      // A returnType of undefined is an error. Unfortunately the field is called undefined.
      if (value['undefined']) {
        // Expression evaluated to error
        return `Error '${value.undefined.causeMessage}' occurred ${count} time(s)`
      } else if (typeCompressed) {
        // These types are recursive and are hard to read
        return `[object Object] returned ${count} time(s)`
      } else if (typeAllowed) {
        // The response is a simple literal
        // Object.values is not ES2015
        const realValue = Object.keys(value).map((key) => value[key])[0]
        return `Value ${JSON.stringify(realValue)} returned ${count} time(s)`
      } else if (Object.keys(value).length === 0) {
        // Clause not evaluated because of short-circuit.
        return `Expression short-circuited ${count} time(s)`
      } else {
        // For a properly formatted response each value should have one type.
        console.error('Found invalid expression-return type.')
      }
    }).join('\n')
  }
}
</script>
